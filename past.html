<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Neta.</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ËøΩÂä† -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
  <style>
    #searchInput {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 2px solid #222;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    #sortSelect {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 2px solid #222;
      margin-bottom: 15px;
      box-sizing: border-box;
      background: #fff;
      cursor: pointer;
    }
    li {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }
    li span {
      flex: 1 1 auto;
      word-break: break-word;
    }
    li button {
      padding: 6px 12px;
      font-size: 14px;
      border: 1px solid #222;
      background: #fff;
      color: #222;
      margin-left: 5px;
      margin-top: 5px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    li button:hover {
      background: #007acc;
      color: #fff;
    }
    #addButton {
      margin-top: 20px;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: 500;
      border: 2px solid #222;
      background: #222;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    #addButton:hover {
      background: #007acc;
      border-color: #007acc;
    }
  </style>
</head>
<body class="pastPage">
  <div class="topBar">
    <button id="addButton" onclick="window.location.href='index.html'">ÈõëË®Ä</button>
    <input type="text" id="searchInput" placeholder="Ê§úÁ¥¢„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
  </div>
  <ul id="jokeList"></ul>
  <div id="loader">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
  <script>
    const jokeList = document.getElementById('jokeList');
    const loader = document.getElementById('loader');
    const searchInput = document.getElementById('searchInput');
    let displayIndex = 0;
    let mixedJokes = [];
    let isLoading = false;

    // =======================
    // Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà
    // =======================
    function formatDate(value) {
      if (!value) return "";
      const d = new Date(value);
      if (isNaN(d)) return "";
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    // =======================
    // ‰∫∫Ê∞ó„Éô„Éº„ÇπÔºã„É©„É≥„ÉÄ„É†Ê∑∑ÂêàÔºãÊ§úÁ¥¢ÂØæÂøú
    // =======================
    function prepareJokes(filter = '') {
      let jokes = JSON.parse(localStorage.getItem('jokes') || '[]');
      if (filter) {
        jokes = jokes.filter(j => j.text.toLowerCase().includes(filter.toLowerCase()));
      }
      if (!jokes.length) {
        mixedJokes = [];
        return;
      }

      // =======================
      // Èáç„Åø‰ªò„Åç„É©„É≥„ÉÄ„É†„Ç∑„É£„ÉÉ„Éï„É´
      // =======================
      const pool = jokes.map(j => ({ ...j, weight: Math.sqrt((j.likes || 0) + 1) }));
      mixedJokes = [];
      while (pool.length > 0) {
        const totalWeight = pool.reduce((sum, j) => sum + j.weight, 0);
        let r = Math.random() * totalWeight;
        let selectedIndex = 0;
        for (let i = 0; i < pool.length; i++) {
          r -= pool[i].weight;
          if (r <= 0) {
            selectedIndex = i;
            break;
          }
        }
        mixedJokes.push(pool[selectedIndex]);
        pool.splice(selectedIndex, 1);
      }
    }

    // =======================
    // 10‰ª∂„Åö„Å§„É≠„Éº„Éâ
    // =======================
    function loadMore(isInitial = false) {
      if (isLoading) return;
      if (displayIndex >= mixedJokes.length) return;
      isLoading = true;
      if (!isInitial) {
        loader.style.display = 'block';
        loader.textContent = "Ë™≠„ÅøËæº„Åø‰∏≠...";
      }
      const executeLoad = () => {
        const nextItems = mixedJokes.slice(displayIndex, displayIndex + 10);
        nextItems.forEach(j => {
          const li = document.createElement('li');
          const span = document.createElement('span');
          // ÊîπË°å„Çí <br> „Å´Â§âÊèõ„Åó„Å¶ HTML „Å®„Åó„Å¶Ë°®Á§∫
          span.innerHTML = j.text.replace(/\n/g, '<br>');

          // „ÅÑ„ÅÑ„Å≠„Éú„Çø„É≥
          const likeBtn = document.createElement('button');
          likeBtn.className = 'likeBtn';
          likeBtn.textContent = `ÈõëË®Ä ${j.likes||0}`;
          likeBtn.addEventListener('click', () => {
  let allJokes = JSON.parse(localStorage.getItem('jokes') || '[]');
  const target = allJokes.find(item => item.id === j.id);

  if (target) {
      target.likes = (target.likes||0) + 1;
      localStorage.setItem('jokes', JSON.stringify(allJokes));

      // „Éú„Çø„É≥Ë°®Á§∫Êõ¥Êñ∞
      likeBtn.textContent = `ÈõëË®Ä ${target.likes}`;

      // „Éè„Éº„ÉàÊºîÂá∫
      const heart = document.createElement('span');
      heart.className = 'heart';
      heart.textContent = 'ü§∑‚Äç‚ôÇÔ∏è';

      // „Éú„Çø„É≥„ÅÆÂ∫ßÊ®ô„ÇíÂèñÂæó„Åó„Å¶„Çπ„ÇØ„É≠„Éº„É´‰ΩçÁΩÆ„ÇíÂä†Âë≥
      const rect = likeBtn.getBoundingClientRect();
      heart.style.left = (rect.left + rect.width / 2 + window.scrollX - 10) + 'px';
      heart.style.top = (rect.top + window.scrollY - 20) + 'px';

      document.body.appendChild(heart);

      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´ÂâäÈô§
      setTimeout(() => {
          heart.remove();
      }, 1000);
  }
});

          // ÂâäÈô§„Éú„Çø„É≥
          const delBtn = document.createElement('button');
          delBtn.className = 'delBtn';
          delBtn.textContent = "ÂâäÈô§";
// ÂâäÈô§„Éú„Çø„É≥
delBtn.addEventListener('click', () => {
  const ok = confirm("Êú¨ÂΩì„Å´„Åì„ÅÆÊäïÁ®ø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü");
  if (!ok) return;

  // localStorage„Åã„ÇâÂâäÈô§
  let allJokes = JSON.parse(localStorage.getItem('jokes') || '[]');
  allJokes = allJokes.filter(item => item.id !== j.id);
  localStorage.setItem('jokes', JSON.stringify(allJokes));

  // mixedJokes„Åã„Çâ„ÇÇÂâäÈô§
  mixedJokes = mixedJokes.filter(item => item.id !== j.id);

  // DOM„Åã„Çâ„ÇÇÂâäÈô§
  li.remove();

  // displayIndex „ÇíÊõ¥Êñ∞ÔºàÂâäÈô§ÂàÜ„Å†„ÅëÔºâ
  displayIndex = Math.min(displayIndex, mixedJokes.length);

  // loader„ÅÆË°®Á§∫Ë™øÊï¥
  if (displayIndex >= mixedJokes.length) {
    loader.style.display = 'block';
    loader.textContent = "„Åì„Çå‰ª•‰∏ä„ÅÇ„Çä„Åæ„Åõ„Çì";
  } else {
    loader.style.display = 'none';
  }
});

          const btnWrap = document.createElement('div');
          btnWrap.className = 'btnWrap';

          // Êó•‰ªòÔºà„ÅÑ„ÅÑ„Å≠„ÅÆÂ∑¶Ôºâ
          const dateSpan = document.createElement('span');
          dateSpan.textContent = formatDate(j.date);
          dateSpan.style.marginRight = "8px";

          btnWrap.appendChild(dateSpan);
          btnWrap.appendChild(likeBtn);
          btnWrap.appendChild(delBtn);

          li.appendChild(span);
          li.appendChild(btnWrap);
          jokeList.appendChild(li);
        });
        displayIndex += 10;
        if (displayIndex >= mixedJokes.length) {
          loader.style.display = 'block';
          loader.textContent = "„Åì„Çå‰ª•‰∏ä„ÅÇ„Çä„Åæ„Åõ„Çì";
        } else {
          loader.style.display = 'none';
        }
        isLoading = false;
      };
      if (isInitial) {
        executeLoad();
      } else {
        setTimeout(executeLoad, 1000);
      }
    }

    // =======================
    // „É™„Çª„ÉÉ„ÉàÂá¶ÁêÜ
    // =======================
    function resetAndReload() {
      jokeList.innerHTML = '';
      displayIndex = 0;
      prepareJokes(searchInput.value);
      loadMore(true);
    }

    // =======================
    // „Çπ„ÇØ„É≠„Éº„É´Ê§úÁü•
    // =======================
    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
        loadMore();
      }
    });

    // =======================
    // Ê§úÁ¥¢„Ç§„Éô„É≥„Éà
    // =======================
    searchInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    // „Ç®„É≥„Çø„Éº„ÅåÊäº„Åï„Çå„Åü„ÇâÊ§úÁ¥¢
    resetAndReload();
  }
});

    let lastScrollY = window.scrollY;
const topBar = document.querySelector('.topBar');

window.addEventListener('scroll', () => {
  const currentScrollY = window.scrollY;

  if (currentScrollY === 0) {
    // „Éö„Éº„Ç∏„Éà„ÉÉ„Éó„Åß„ÅØÂøÖ„ÅöË°®Á§∫
    topBar.style.transform = 'translateY(0)';
  } else if (currentScrollY < lastScrollY) {
    // ‰∏ä„Çπ„ÇØ„É≠„Éº„É´ ‚Üí Ë°®Á§∫
    topBar.style.transform = 'translateY(0)';
  } else if (currentScrollY > lastScrollY) {
    // ‰∏ã„Çπ„ÇØ„É≠„Éº„É´ ‚Üí Èö†„Åô
    topBar.style.transform = 'translateY(-100%)';
  }

  lastScrollY = currentScrollY;
});

    // ÂàùÊúüÂåñ
    prepareJokes();
    // „É≠„Éº„ÉâË°®Á§∫„Çí2ÁßíÊåü„ÇÄ
    loader.style.display = 'block';
    loader.textContent = "Ë™≠„ÅøËæº„Åø‰∏≠...";
    setTimeout(() => { loadMore(true); }, 2000);
    loadMore(true);
  </script>
</body>
</html>